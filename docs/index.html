<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Router Example</title>
    <style>
        .nav-link {
            margin: 0 10px;
            cursor: pointer;
            color: blue;
            text-decoration: underline;
        }
        .content {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <nav>
        <span id="home-link" class="nav-link">Home</span>
        <span id="about-link" class="nav-link">About</span>
        <span id="contact-link" class="nav-link">Contact</span>
    </nav>
    <div class="content" id="content">
        <!-- Content will be loaded here based on the route -->
    </div>

    <script type="module">
        type RouteHandler = () => Promise<void>;

        interface Route {
            path: string;
            handler: RouteHandler;
        }

        class Router {
            private routes: Route[] = [];
            private mode: 'history' | 'hash';
            private root: string;

            constructor(mode: 'history' | 'hash' = 'history', root: string = '/') {
                this.mode = mode;
                this.root = root;
                this.listen();
            }

            private listen() {
                if (this.mode === 'history') {
                    window.addEventListener('popstate', (event) => {
                        this.handleRoute(location.pathname);
                    });
                } else {
                    window.addEventListener('hashchange', (event) => {
                        this.handleRoute(location.hash.slice(1));
                    });
                }
            }

            public addRoute(path: string, handler: RouteHandler): Router {
                this.routes.push({ path, handler });
                return this;
            }

            public navigate(path: string) {
                if (!this.isSafeUrl(path)) {
                    console.error('Unsafe URL, navigation aborted');
                    return;
                }
                if (this.mode === 'history') {
                    history.pushState(null, '', path);
                    this.handleRoute(path);
                } else {
                    location.hash = path;
                }
            }

            private async handleRoute(path: string) {
                const route = this.routes.find(route => route.path === path);
                if (route) {
                    try {
                        await route.handler();
                    } catch (error) {
                        console.error(`Error while handling route: ${error}`);
                    }
                } else {
                    console.error(`Route not found: ${path}`);
                }
            }

            private isSafeUrl(url: string): boolean {
                const pattern = /^(\/|#\/)[\w\-\/]*$/;
                return pattern.test(url);
            }

            public start() {
                const path = this.mode === 'history' ? location.pathname : location.hash.slice(1);
                this.handleRoute(path);
            }
        }

        const contentDiv = document.getElementById('content') as HTMLElement;

        const router = new Router('history');

        router
            .addRoute('/', async () => {
                contentDiv.innerHTML = '<h1>Home</h1><p>Welcome to the home page!</p>';
            })
            .addRoute('/about', async () => {
                contentDiv.innerHTML = '<h1>About</h1><p>This is the about page.</p>';
            })
            .addRoute('/contact', async () => {
                contentDiv.innerHTML = '<h1>Contact</h1><p>Get in touch with us through the contact page.</p>';
            });

        router.start();

        document.getElementById('home-link')?.addEventListener('click', () => router.navigate('/'));
        document.getElementById('about-link')?.addEventListener('click', () => router.navigate('/about'));
        document.getElementById('contact-link')?.addEventListener('click', () => router.navigate('/contact'));
    </script>
</body>
</html>
